/*
 * wapper.cpp
 *
 *  Created on: Feb 14, 2023
 *      Author: IndigoCarmine
 */
#include "main.h"

extern "C" CAN_HandleTypeDef hcan;

// callback function, called from an interrupt (CAN_IT_RX_FIFO0_MSG_PENDING).
void can_rx_callback(CAN_HandleTypeDef *hcan)
{
  HAL_GPIO_TogglePin(LED_CAN_GPIO_Port, LED_CAN_Pin);
  HAL_GPIO_TogglePin(LED_YELLOW_GPIO_Port, LED_YELLOW_Pin);
  CAN_RxHeaderTypeDef RxHeader;
  uint8_t RxData[8];
  if (HAL_CAN_GetRxMessage(hcan, CAN_RX_FIFO0, &RxHeader, RxData) == HAL_OK)
  {
    // Some code for receive data
  }
}

void setup()
{
  // put your setup code here, to run once:

  // Filter setting
  CAN_FilterTypeDef filter;
  filter.FilterIdHigh = 0;                        // フィルターID(上�?16ビッ???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?)
  filter.FilterIdLow = 0;                         // フィルターID(下�?16ビッ???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?)
  filter.FilterMaskIdHigh = 0;                    // フィルターマスク(上�?16ビッ???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?)
  filter.FilterMaskIdLow = 0;                     // フィルターマスク(下�?16ビッ???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?)
  filter.FilterScale = CAN_FILTERSCALE_32BIT;     // フィルタースケール
  filter.FilterFIFOAssignment = CAN_FILTER_FIFO0; // フィルターに割り当てるFIFO
  filter.FilterBank = 0;                          // フィルターバンクNo
  filter.FilterMode = CAN_FILTERMODE_IDMASK;      // フィルターモー???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?
  filter.SlaveStartFilterBank = 14;               // スレーブCANの開始フィルターバンクNo
  filter.FilterActivation = ENABLE;               // フィルター無効????????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��有効
  if (HAL_CAN_ConfigFilter(&hcan, &filter) != HAL_OK)
  {
    Error_Handler();
  }

  // 割り込み処理の開始
  if (HAL_CAN_ActivateNotification(&hcan, CAN_IT_RX_FIFO0_MSG_PENDING) != HAL_OK)
  {
    Error_Handler();
  }

  HAL_CAN_Start(&hcan);

  HAL_GPIO_TogglePin(LED_CAN_GPIO_Port, LED_CAN_Pin);
  HAL_GPIO_TogglePin(LED_YELLOW_GPIO_Port, LED_YELLOW_Pin);
}

CAN_TxHeaderTypeDef TxHeader;
uint32_t TxMailbox;
void loop()
{
  HAL_Delay(1000);
  HAL_GPIO_TogglePin(LED_GREEN_GPIO_Port, LED_GREEN_Pin);

  TxHeader.DLC = 8;
  TxHeader.RTR = CAN_RTR_DATA;
  TxHeader.IDE = CAN_ID_STD;
  TxHeader.StdId = 0x11;
  TxHeader.TransmitGlobalTime = DISABLE;
  uint8_t data[] = {0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00};

  if (0 < HAL_CAN_GetTxMailboxesFreeLevel(&hcan))
  {
    HAL_GPIO_TogglePin(LED_GREEN_GPIO_Port, LED_GREEN_Pin);
    HAL_CAN_AddTxMessage(&hcan, &TxHeader, data, &TxMailbox);
    HAL_Delay(1000);
  }
}
